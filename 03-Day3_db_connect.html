<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>R Camp | day 3</title>

<script src="03-Day3_db_connect_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="03-Day3_db_connect_files/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="03-Day3_db_connect_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="03-Day3_db_connect_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="03-Day3_db_connect_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="03-Day3_db_connect_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="03-Day3_db_connect_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="03-Day3_db_connect_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="03-Day3_db_connect_files/navigation-1.1/tabsets.js"></script>
<link href="03-Day3_db_connect_files/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="03-Day3_db_connect_files/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="03-Day3_db_connect_files/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="css\camp_style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">R Camp | day 3</h1>

</div>


<style> code {color: #535353 !important;} </style>
<div id="data-paths" class="section level1">
<h1>Data paths</h1>
<p><img src="https://www.themarysue.com/wp-content/uploads/2014/11/cyoa002hb.jpg" width="280" align="right" style="margin-top: -145px; margin-right: 20px"></p>
<ol style="list-style-type: decimal">
<li><strong>Database connections</strong></li>
<li><a href="03-Day3_GIS.html">GIS &amp; Shapefiles</a></li>
<li><a href="03-Day3_web_data.html">Web data</a></li>
<li><a href="03-Day3_tableau.html">Tableau</a></li>
<li><a href="03-Day3_other_stats.html">Other Stats software: SAS, SPSS, MATLAB</a></li>
</ol>
<p><br></p>
</div>
<div id="database-connections" class="section level1">
<h1>Database connections</h1>
<div id="sick-dogs" class="section level2">
<h2>Sick dogs</h2>
<p>A string of dog deaths has left public health officials scratching their heads. Are cats finally getting their revenge or is there some other funny business at play?</p>
<p>After a few days of chasing down dead-ends, you find a fax waiting for you in your office. The letterhead shows the logo for the Wisconsin DNR. That’s odd. The last time you heard from them was during the great chameleon outbreak of 1992.</p>
<p>The letter contains the following warning:</p>
<div class="figure">
<img src="https://dogtrekker.com/userfiles//GreenDogCCJillSiegrist.gif" align="right" style="margin-left: 22px;" width="220" />

</div>
<blockquote>
<p>Prepare yourselves!</p>
<p>The deadly <em>Caninus-morbidium</em> (CM) is believed to be headed your way. We’ve found that it likes warm water and low oxygen, but it really dislikes fish and fast moving water.</p>
<p>According to our measurements we’ve seen them living in temperatures greater than 23 C, but less than 27 C. The dissolved oxygen range has been greater than 4, but less than 6.</p>
</blockquote>
<p><br><br></p>
<p><strong>Which water bodies in MN would be hospitable to this bacteria?</strong></p>
</div>
<div id="tempo-delta-oracle-databases" class="section level2">
<h2>TEMPO &amp; Delta: <em>Oracle databases</em></h2>
<p><br></p>
<p>To get started you need to tell your computer where <em>Delta</em> is.</p>
<ol style="list-style-type: decimal">
<li>Open the <em>Control Panel</em> &gt; <em>Administrative Tools</em> &gt; <em>Data Sources (ODBC)</em></li>
<li>Click the <strong>[Add…]</strong> button.</li>
<li>Driver Name: <strong>Oracle in OraClient11g_home2</strong></li>
<li>Data Source Name: <strong>deltaw</strong></li>
<li>TNS Service Name: <strong>deltaw.pca.state.mn.us</strong></li>
</ol>
<p>You can leave the rest blank. Click the <strong>[Test Connection]</strong> button.</p>
<p>Enter the top secret <strong>User Name:</strong> <code>t*********</code> and <strong>Password:</strong> <code>d***_**</code>.</p>
<p><em>If you need a user name and password contact the Data Desk at <a href="DataDesk.MPCA@state.mn.us" class="uri">DataDesk.MPCA@state.mn.us</a>.</em></p>
<p>Once you get a <code>Connection successful!</code> message. You’re all set. Close out and return to RStudio.</p>
<p><br></p>
<div id="facility-locations" class="section level3">
<h3>Facility locations</h3>
<p>Let’s find the location of some facilities.</p>
<p><br></p>
<p>You can view the available database connections in R using the function <code>odbcDataSources()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(RODBC)

<span class="kw">odbcDataSources</span>()</code></pre></div>
<pre><code>##                                              dBASE Files 
##    &quot;Microsoft Access dBASE Driver (*.dbf, *.ndx, *.mdx)&quot; 
##                                              Excel Files 
## &quot;Microsoft Excel Driver (*.xls, *.xlsx, *.xlsm, *.xlsb)&quot; 
##                                       MS Access Database 
##               &quot;Microsoft Access Driver (*.mdb, *.accdb)&quot; 
##                                       LakesXMLDataSource 
##                                &quot;CR ODBC XML Driver 4.20&quot; 
##                                            PostgreSQL35W 
##                                &quot;PostgreSQL Unicode(x64)&quot; 
##                                                   onbase 
##                           &quot;Oracle in OraClient11g_home1&quot; 
##                                                  onbaset 
##                           &quot;Oracle in OraClient11g_home1&quot; 
##                                                  onbased 
##                           &quot;Oracle in OraClient11g_home1&quot; 
##                                                   deltaw 
##                           &quot;Oracle in OraClient11g_home1&quot;</code></pre>
<p><br></p>
<p>To connect to <code>deltaw</code> use the function <code>odbcConnect()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readr)

<span class="co"># Load credentials</span>
credentials &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/Student Folder/credentials.csv&quot;</span>)

user      &lt;-<span class="st"> </span>credentials<span class="op">$</span>delta_user
password  &lt;-<span class="st"> </span>credentials<span class="op">$</span>delta_pwd

<span class="co"># Or use your own</span>
<span class="co">#user      &lt;- &quot;ta*******&quot;</span>
<span class="co">#password  &lt;- &quot;da**_*******&quot;</span>
  
<span class="co"># Connect to Delta</span>
deltaw &lt;-<span class="st"> </span><span class="kw">odbcConnect</span>(<span class="st">&quot;deltaw&quot;</span>, 
                      <span class="dt">uid =</span> user, 
                      <span class="dt">pwd =</span> password,
                      <span class="dt">believeNRows =</span> <span class="ot">FALSE</span>)  


<span class="co"># View all schemas in deltaw</span>
<span class="kw">sqlTables</span>(deltaw)<span class="op">$</span>TABLE_SCHEM <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>()</code></pre></div>
<pre><code>##   [1] &quot;ADB&quot;                  &quot;ADM_DELTA&quot;            &quot;APP_EXTERNAL&quot;        
##   [4] &quot;APP_INTERNAL&quot;         &quot;AQ_DELTA&quot;             &quot;ASSESS&quot;              
##   [7] &quot;CGI_RO&quot;               &quot;CMP_DATA&quot;             &quot;CMP_WEB&quot;             
##  [10] &quot;CNELSON1&quot;             &quot;CORE_SDW&quot;             &quot;CORE_WU&quot;             
##  [13] &quot;CORE_WU_LINK_USER&quot;    &quot;COREUSER&quot;             &quot;CSW&quot;                 
##  [16] &quot;CTOP_DELTA&quot;           &quot;CWU&quot;                  &quot;DB_COMMENTS&quot;         
##  [19] &quot;DOCTRACK&quot;             &quot;ELM&quot;                  &quot;ENF_DB&quot;              
##  [22] &quot;ENV_STDS&quot;             &quot;ENV_STDS_LINK_USER&quot;   &quot;EQUIS&quot;               
##  [25] &quot;EQUIS_TEST&quot;           &quot;EQUIS_USER&quot;           &quot;EQUISDW&quot;             
##  [28] &quot;EQUISDW2&quot;             &quot;EQUISFE&quot;              &quot;EQUISPU&quot;             
##  [31] &quot;EQUISRO&quot;              &quot;ETRACK&quot;               &quot;FILE_MGT&quot;            
##  [34] &quot;GRANTS_DATA&quot;          &quot;HERE_FLOW&quot;            &quot;HW_DELTA&quot;            
##  [37] &quot;INCIDENT&quot;             &quot;ISW&quot;                  &quot;MIG_AQ_POST_R1&quot;      
##  [40] &quot;MIG_AQ_POST_R2_CE&quot;    &quot;MIG_CNVD&quot;             &quot;MIG_DELTA&quot;           
##  [43] &quot;MIG_DELTA_R2&quot;         &quot;MIG_DELTA_R3&quot;         &quot;MIG_DELTA_R4&quot;        
##  [46] &quot;MIG_EDMS&quot;             &quot;MPCA_BOL&quot;             &quot;MPCA_DAL&quot;            
##  [49] &quot;MPCA_REPORT&quot;          &quot;NAGIOS_ADMIN&quot;         &quot;NCT&quot;                 
##  [52] &quot;NIGHTLY&quot;              &quot;NODE_FLOW&quot;            &quot;NODE_FLOW_LINK_USER&quot; 
##  [55] &quot;NODE_FLOW_USR&quot;        &quot;ONBASE_LINK&quot;          &quot;OPAL&quot;                
##  [58] &quot;PCASEND&quot;              &quot;PEST&quot;                 &quot;PROJECT_TRACKING&quot;    
##  [61] &quot;PUBLIC&quot;               &quot;RAPIDS&quot;               &quot;RESTFUL_UTIL&quot;        
##  [64] &quot;RSP&quot;                  &quot;SA_DATA&quot;              &quot;SDW_UTIL&quot;            
##  [67] &quot;SPATIAL_PROD&quot;         &quot;SR_DELTA&quot;             &quot;SUPERAPIDS&quot;          
##  [70] &quot;SW_DELTA&quot;             &quot;SYS&quot;                  &quot;SYSTEM&quot;              
##  [73] &quot;TABLEAU&quot;              &quot;TACS&quot;                 &quot;TANKS&quot;               
##  [76] &quot;TEMPO&quot;                &quot;TEMPO_MIG&quot;            &quot;TEMPO_MN_CORE_WU&quot;    
##  [79] &quot;TEMPO_MN_LB&quot;          &quot;TEMPO_MN_QUEUE&quot;       &quot;TEMPO_MN_RAPIDS&quot;     
##  [82] &quot;TEMPO_MN_UTIL&quot;        &quot;TEMPOAP&quot;              &quot;TEMPOBP&quot;             
##  [85] &quot;THE_CRANK&quot;            &quot;TIM_UPD&quot;              &quot;TOAD&quot;                
##  [88] &quot;WH_AQ_EDA&quot;            &quot;WH_CSW&quot;               &quot;WH_CSW_2&quot;            
##  [91] &quot;WH_GROUNDWATER&quot;       &quot;WH_HAZARDOUS_WASTE&quot;   &quot;WH_HAZARDOUS_WASTE_2&quot;
##  [94] &quot;WH_ISW&quot;               &quot;WH_ISW_2&quot;             &quot;WH_ONBASE&quot;           
##  [97] &quot;WH_SSTS&quot;              &quot;WH_SURFACEWATER&quot;      &quot;WH_SURFACEWATER_2&quot;   
## [100] &quot;WH_TANKS&quot;             &quot;WH_TANKS_2&quot;           &quot;WH_TEMPO&quot;            
## [103] &quot;WH_WIMN_2&quot;            &quot;WIMN&quot;                 &quot;WIX&quot;                 
## [106] &quot;WJPORTER&quot;             &quot;WQ_ASSESS&quot;            &quot;WQ_ASSESS_LINK_USER&quot; 
## [109] &quot;WQ_BIO&quot;               &quot;WQ_DELTA&quot;             &quot;WQISTS&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># View the tables inside the Warehouse TEMPO schema</span>
tbl_list_wh &lt;-<span class="st"> </span><span class="kw">sqlTables</span>(deltaw, <span class="dt">schema =</span> <span class="st">&quot;WH_TEMPO&quot;</span>)

<span class="co"># View the tables inside the real TEMPO</span>
tbl_list &lt;-<span class="st"> </span><span class="kw">sqlTables</span>(deltaw, <span class="dt">schema =</span> <span class="st">&quot;TEMPO&quot;</span>)

<span class="co"># Let&#39;s find the MN chickens!</span>
<span class="co"># Get the first 10 results in &quot;MV_FEEDLOT&quot;</span>
feedlots  &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="st">&quot;SELECT * FROM WH_TEMPO.MV_FEEDLOT&quot;</span>, 
                      <span class="dt">max =</span> <span class="dv">10</span>,  <span class="co"># Row limit for data pull, start small</span>
                      <span class="dt">stringsAsFactors =</span> F)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">MASTER_AI_ID</th>
<th align="right">INT_DOC_ID</th>
<th align="left">MASTER_AI_NAME</th>
<th align="left">AI_PROGRAM_LIST</th>
<th align="left">FEEDLOT_STATUS</th>
<th align="left">REG_ACTIVITY_ID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">970</td>
<td align="right">0</td>
<td align="left">Sustane Compost Facility</td>
<td align="left">FE</td>
<td align="left">active</td>
<td align="left">REG20100001</td>
</tr>
<tr class="even">
<td align="right">1025</td>
<td align="right">0</td>
<td align="left">Luoma Egg Ranch Inc</td>
<td align="left">CS, FE, HW, SA, UT</td>
<td align="left">active</td>
<td align="left">REG20110001</td>
</tr>
<tr class="odd">
<td align="right">1701</td>
<td align="right">0</td>
<td align="left">Blair West Site</td>
<td align="left">EV, FE, WW</td>
<td align="left">active</td>
<td align="left">REG20150002</td>
</tr>
<tr class="even">
<td align="right">1915</td>
<td align="right">0</td>
<td align="left">Heartland Hutterian Brethren/Heartland Colonies</td>
<td align="left">FE, HW, RR, SW, WW</td>
<td align="left">active</td>
<td align="left">REG20140001</td>
</tr>
<tr class="odd">
<td align="right">1923</td>
<td align="right">0</td>
<td align="left">Feikema Farms Home</td>
<td align="left">FE</td>
<td align="left">active</td>
<td align="left">REG20140001</td>
</tr>
<tr class="even">
<td align="right">1925</td>
<td align="right">0</td>
<td align="left">Gabrielson Paul</td>
<td align="left">FE</td>
<td align="left">inactive</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>Now for some real TEMPO seriousness.</strong></p>
</div>
</div>
<div id="get-tempo-agency-interest-names-and-ids" class="section level2">
<h2>Get TEMPO Agency Interest names and IDs</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fac_ids   &lt;-<span class="st"> </span><span class="kw">sqlFetch</span>(deltaw, <span class="st">&quot;TEMPO.AGENCY_INTEREST&quot;</span>, <span class="dt">max =</span> <span class="dv">10000</span>, <span class="dt">stringsAsFactors =</span> F)

<span class="kw">glimpse</span>(fac_ids)</code></pre></div>
<pre><code>## Observations: 10,000
## Variables: 10
## $ MASTER_AI_ID   &lt;int&gt; 4445, 4446, 4447, 4448, 4449, 4450, 4451, 4452,...
## $ INT_DOC_ID     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ MASTER_AI_NAME &lt;chr&gt; &quot;Parkview Estates (Lake Elmo)&quot;, &quot;Kilkenny Pond&quot;...
## $ AI_TYPE_CODE   &lt;chr&gt; &quot;CON&quot;, &quot;CON&quot;, &quot;CON&quot;, &quot;CON&quot;, &quot;CON&quot;, &quot;CON&quot;, &quot;CON&quot;...
## $ START_DATE     &lt;dttm&gt; 1999-02-22 00:00:00, 1999-02-22 00:00:00, 1999...
## $ END_DATE       &lt;dttm&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ USER_LAST_UPDT &lt;chr&gt; &quot;SYSTEM  &quot;, &quot;SYSTEM  &quot;, &quot;RGAGLE  &quot;, &quot;RGAGLE  &quot;,...
## $ TMSP_LAST_UPDT &lt;dttm&gt; 2013-02-05 12:14:16, 2013-02-05 12:14:16, 2014...
## $ USER_CREATED   &lt;chr&gt; &quot;DELTA_M_R1&quot;, &quot;DELTA_M_R1&quot;, &quot;DELTA_M_R1&quot;, &quot;DELT...
## $ TMSP_CREATED   &lt;dttm&gt; 1999-02-22 08:33:28, 1999-02-22 08:38:25, 1999...</code></pre>
</div>
<div id="get-facility-locations" class="section level2">
<h2>Get facility locations</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">locations &lt;-<span class="st"> </span><span class="kw">sqlFetch</span>(deltaw, <span class="st">&quot;TEMPO.SUBJ_ITEM_LOCATION&quot;</span>, <span class="dt">max =</span> <span class="dv">10000</span>, <span class="dt">stringsAsFactors =</span> F)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">MASTER_AI_ID</th>
<th align="right">INT_DOC_ID</th>
<th align="left">SUBJECT_ITEM_CATEGORY_CODE</th>
<th align="right">SUBJECT_ITEM_ID</th>
<th align="left">SECTION_CODE</th>
<th align="left">TOWNSHIP_CODE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2503</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">2503</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="right">2504</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">2504</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="right">2505</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">2505</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="right">2506</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">2506</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="right">2507</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">2507</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="right">4987</td>
<td align="right">0</td>
<td align="left">AISI</td>
<td align="right">4987</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="left_join" class="section level2">
<h2>left_join()</h2>
<p><a href="left_join_examples.html">Go here</a> for an introduction to <code>left_join()</code> using cats.</p>
<p>Now we’re ready to <code>left_join()</code> our two tables together.</p>
<p><img src = "images/left_join_cheat.png" width="420" style="margin-left: 0px;" alt="left_join example"/></p>
<p><br></p>
<p>Using <code>left_join(table_A, table_B)</code> ensures that the result will contain all the rows and columns in <code>table_A</code>. The values in the columns of <code>table_B</code> will only be joined to <code>table_A</code> when they have a value in common. In the case below, location results will only be joined to the <em>fac_ids</em> table, when both tables contain a row of data with the same <code>MASTER_AI_ID</code>.</p>
</div>
<div id="join-locations-to-facilities-using-the-master-ai-id" class="section level2">
<h2>Join locations to facilities using the Master AI ID</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fac_locs  &lt;-<span class="st"> </span><span class="kw">left_join</span>(fac_ids, locations, <span class="dt">by =</span> <span class="st">&quot;MASTER_AI_ID&quot;</span>)

<span class="co"># Show lat/long for facilities</span>
<span class="kw">select</span>(fac_locs, MASTER_AI_ID, MASTER_AI_NAME, X_COORD_VALUE , Y_COORD_VALUE) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">7</span>)</code></pre></div>
<pre><code>##   MASTER_AI_ID                  MASTER_AI_NAME   X_COORD_VALUE
## 1         4445    Parkview Estates (Lake Elmo)            &lt;NA&gt;
## 2         4446                   Kilkenny Pond 484362.77456254
## 3         4447                  Provence Creek 436710.48645318
## 4         4448 Phase 4 Lndfl Const &amp; Access Rd 268891.80158881
## 5         4449                    SP 42-606-08 285430.24316692
## 6         4450                   SAP 42-607-13 280111.77972373
## 7         4451     Lyon County Ditch 62 Improv 280111.77972373
##      Y_COORD_VALUE
## 1             &lt;NA&gt;
## 2  4950423.0653289
## 3 4965334.23034951
## 4 4914447.65435555
## 5 4921407.74623715
## 6 4925821.75474194
## 7 4925821.75474194</code></pre>
<p><br></p>
<div id="pop-quiz-hotshot" class="section level3">
<h3>Pop Quiz, hotshot!</h3>
<p>According to TEMPO, which Municipality is the facilty ‘BrandFX LLC’ located in?</p>
<p><input type="radio"> <em>There is no <code>BrandFX LLC</code> facility.</em> <br> <input type="radio"> <em>Dunnell</em> <br> <input type="radio"> <em>St. Louis</em> <br> <input type="radio"> <em>Mahnomen</em> <br> <input type="radio"> <em>Walker</em> <br></p>
<p><br></p>
<details> <summary class = "btn_code"><em>Show solution</em></summary>
<p>
<p><i class="fa fa-check" aria-hidden="true" style="color: green;"></i> <code>Dunnell</code></p>
<p><em>You sure aren’t kitten around! Great work!</em></p>
</p>
<p></details></p>
<p><br></p>
</div>
</div>
</div>
<div id="water-data" class="section level1">
<h1>Water data</h1>
<div id="equis-water-monitoring" class="section level2">
<h2>EQUIS | Water monitoring</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># View the tables inside the EQUIS schema</span>
equis_tbls &lt;-<span class="st"> </span><span class="kw">sqlTables</span>(deltaw, <span class="dt">schema =</span> <span class="st">&quot;EQUIS&quot;</span>)

equis_tbls <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">11</span>)</code></pre></div>
<pre><code>##    TABLE_CAT TABLE_SCHEM                     TABLE_NAME TABLE_TYPE REMARKS
## 1       &lt;NA&gt;       EQUIS                 ACCEPTABLE_USE      TABLE    &lt;NA&gt;
## 2       &lt;NA&gt;       EQUIS                     AT_COMPANY      TABLE    &lt;NA&gt;
## 3       &lt;NA&gt;       EQUIS              AT_COMPANY_PERSON      TABLE    &lt;NA&gt;
## 4       &lt;NA&gt;       EQUIS                  AT_DQM_RESULT      TABLE    &lt;NA&gt;
## 5       &lt;NA&gt;       EQUIS         AT_EQUIPMENT_PARAMETER      TABLE    &lt;NA&gt;
## 6       &lt;NA&gt;       EQUIS                    AT_FACILITY      TABLE    &lt;NA&gt;
## 7       &lt;NA&gt;       EQUIS         AT_FILE_TYPE_PARAMETER      TABLE    &lt;NA&gt;
## 8       &lt;NA&gt;       EQUIS                    AT_GEO_UNIT      TABLE    &lt;NA&gt;
## 9       &lt;NA&gt;       EQUIS     AT_SAMPLE_CHAIN_OF_CUSTODY      TABLE    &lt;NA&gt;
## 10      &lt;NA&gt;       EQUIS                  AT_SAMPLE_SDG      TABLE    &lt;NA&gt;
## 11      &lt;NA&gt;       EQUIS AT_SPM_COMMITMENT_PLANNED_TASK      TABLE    &lt;NA&gt;</code></pre>
</div>
<div id="pull-equis-surface-water-data" class="section level2">
<h2>Pull EQUIS surface water data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="co"># Grab 5,000 rows from DT_WELL</span>
eq_wells  &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="kw">paste0</span>(<span class="st">&quot;SELECT * FROM EQUIS.DT_WELL&quot;</span>),
                        <span class="dt">max =</span> <span class="dv">5000</span>,
                        <span class="dt">stringsAsFactors =</span> F, 
                        <span class="dt">as.is =</span> T)

<span class="co"># Histogram of well depths</span>
eq_wells <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.numeric</span>(DEPTH_OF_WELL))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_histogram</span>()</code></pre></div>
<p><img src="03-Day3_db_connect_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Boxplot of depth by well purpose</span>
eq_wells &lt;-<span class="st"> </span><span class="kw">mutate</span>(eq_wells, 
                     <span class="dt">DEPTH_OF_WELL =</span> <span class="kw">as.numeric</span>(eq_wells<span class="op">$</span>DEPTH_OF_WELL),
                     <span class="dt">WELL_PURPOSE  =</span> <span class="kw">as.factor</span>(WELL_PURPOSE))

eq_wells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> WELL_PURPOSE, <span class="dt">y =</span> <span class="kw">as.numeric</span>(DEPTH_OF_WELL), <span class="dt">fill =</span> WELL_PURPOSE)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_log10</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="03-Day3_db_connect_files/figure-html/unnamed-chunk-9-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Close all open connections</span>
<span class="kw">odbcCloseAll</span>() </code></pre></div>
</div>
<div id="you-unlocked-a-shortcut" class="section level2">
<h2>You unlocked a shortcut!</h2>
<p>You discovered an EQUIS CSV file.</p>
<p>Read in the water temperature data using <code>read_csv()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readr)

## CSV file location
filepath &lt;-<span class="st"> &quot;X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/Student Folder/Sample data/surface_water_temp_2015_16.csv&quot;</span>

<span class="co"># This file is BIG!</span>
sw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(filepath)

<span class="co"># Show top rows</span>
<span class="kw">head</span>(sw[ , <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   FACILITY_ID FACILITY_CODE SYS_LOC_CODE   LOC_NAME   SAMPLE_ID
##         &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;          &lt;chr&gt;          &lt;int&gt;
## 1           1 MNPCA         S005-170       &lt;NA&gt;        33429119
## 2           1 MNPCA         S005-170       &lt;NA&gt;        33429120
## 3           1 MNPCA         S005-170       &lt;NA&gt;        33429121
## 4           1 MNPCA         38-0637-00-203 Bald Eagle  37064183
## 5           1 MNPCA         38-0637-00-203 Bald Eagle  37064184
## 6           1 MNPCA         38-0637-00-203 Bald Eagle  37064185</code></pre>
<p><br></p>
<p>You will see a few issues with this data.</p>
<ul>
<li>There are location names missing.</li>
<li>There are results flagged as not detected.</li>
<li>There are a lot of excess columns we don’t need.</li>
</ul>
<p>Let’s use our favorite <em>dplyr</em> functions to clean it up.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="co"># Take a quick look</span>
<span class="kw">glimpse</span>(sw)


<span class="co"># Get rid of missing locations</span>
sw &lt;-<span class="st"> </span><span class="kw">filter</span>(sw, <span class="op">!</span><span class="kw">is.na</span>(LOC_NAME))


<span class="co"># Keep only the detected values</span>
## Warning: This usually isn&#39;t a great idea, but we&#39;re in a hurry.
## Good practice would be to review missing values, and generate summaries that incorporate non-detect values.
sw &lt;-<span class="st"> </span><span class="kw">filter</span>(sw, DETECT_FLAG <span class="op">==</span><span class="st"> &quot;Y&quot;</span>)


<span class="co"># Keep only *useful* columns</span>
sw &lt;-<span class="st"> </span><span class="kw">select</span>(sw, LOC_NAME, SAMPLE_DATE, CHEMICAL_NAME, REPORT_RESULT_VALUE, REPORT_RESULT_UNIT)</code></pre></div>
</div>
<div id="lets-compare-temperature-to-dissolved-oxygen" class="section level2">
<h2>Let’s compare temperature to dissolved oxygen</h2>
<blockquote>
<p>All of the temperature and dissolved oxygen results are in the same column with the chemical name in a separate column. What if we want the dissolved oxygen and temparture results in separate columns?</p>
</blockquote>
<p>We can use the <code>spread()</code> function from the <em>tidyr</em> package to do this. Let’s install it!</p>
<div class="figure">
<img src="https://d21ii91i3y6o6h.cloudfront.net/gallery_images/from_proof/9290/medium/1447092142/tidyr-hexbin-sticker-from-rstudio.png" />

</div>
<p><code>install.packages(&quot;tidyr&quot;)</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)

sw_wide &lt;-<span class="st"> </span><span class="kw">spread</span>(sw, CHEMICAL_NAME, REPORT_RESULT_VALUE) 

<span class="co"># Error!!! See below to resolve.</span></code></pre></div>
<p><br></p>
<blockquote>
<p>We’re getting an error because we have multiple observations (duplicates) for the exact same sampling time. Let’s average the results taken at the same place and time.</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Group by site, date, and chemical; and then average the observation</span>
sw &lt;-<span class="st"> </span>sw  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">group_by</span>(LOC_NAME, SAMPLE_DATE, CHEMICAL_NAME, REPORT_RESULT_UNIT) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">summarize</span>(<span class="dt">REPORT_RESULT_VALUE =</span> <span class="kw">mean</span>(REPORT_RESULT_VALUE, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">ungroup</span>()

<span class="co"># Now let&#39;s try splitting the observation into 2 columns again.</span>
sw_wide &lt;-<span class="st"> </span><span class="kw">spread</span>(sw, CHEMICAL_NAME, REPORT_RESULT_VALUE)

<span class="co"># Show table</span>
<span class="kw">head</span>(sw_wide)</code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   LOC_NAME SAMPLE_DATE  REPORT_RESULT_U~ `Dissolved oxyg~ `Temperature, w~
##   &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt;                       &lt;dbl&gt;            &lt;dbl&gt;
## 1 14MN060  7/21/2016 1~ deg C                       NA                23.9
## 2 14MN060  7/21/2016 1~ mg/L                         7.1              NA  
## 3 14MN060  8/3/2016 10~ deg C                       NA                25.4
## 4 14MN060  8/3/2016 10~ mg/L                         7.27             NA  
## 5 14MN080  6/30/2016 1~ deg C                       NA                19.1
## 6 14MN080  6/30/2016 1~ mg/L                         8.48             NA</code></pre>
<p>This looks great, <code>Temp</code> and <code>DO</code> are in separate columns, but something doesn’t look right. The unit column is creating different rows for temp and DO, so let’s remove the units column for now.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Drop units column</span>
sw &lt;-<span class="st"> </span><span class="kw">select</span>(sw, <span class="op">-</span>REPORT_RESULT_UNIT)

<span class="co"># Try the 3rd time, it&#39;ll be charmed</span>
sw_wide &lt;-<span class="st"> </span><span class="kw">spread</span>(sw, CHEMICAL_NAME, REPORT_RESULT_VALUE)

<span class="kw">head</span>(sw_wide)</code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   LOC_NAME SAMPLE_DATE           `Dissolved oxygen (DO)` `Temperature, wa~
##   &lt;chr&gt;    &lt;chr&gt;                                   &lt;dbl&gt;             &lt;dbl&gt;
## 1 14MN060  7/21/2016 11:30:00 AM                    7.1               23.9
## 2 14MN060  8/3/2016 10:50:00 AM                     7.27              25.4
## 3 14MN080  6/30/2016 1:50:00 PM                     8.48              19.1
## 4 14MN081  3/2/2016 2:00:00 PM                     13.7                0.6
## 5 14MN081  6/30/2016 2:10:00 PM                     6.19              21.0
## 6 Acorn    5/12/2016 12:00:00 PM                    9.81              13.0</code></pre>
<p>Things look good now, but the <code>DO</code> and <code>temp</code> column names have spaces in them. We can technically leave them this way, but they can create trouble for us later on. Let’s use <code>names()</code> to tidy them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Assign the table names as a list</span>
<span class="kw">names</span>(sw_wide) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;location&quot;</span>, <span class="st">&quot;sample_date&quot;</span>, <span class="st">&quot;DO_mg_per_L&quot;</span>, <span class="st">&quot;temp_C&quot;</span>)</code></pre></div>
</div>
<div id="now-back-to-killer-bacteria" class="section level2">
<h2>Now back to <em>KILLER</em> bacteria</h2>
<div class="figure">
<img src="https://images.duckduckgo.com/iu/?u=http%3A%2F%2Fwww.anh-usa.org%2Fwp-content%2Fuploads%2F2015%2F04%2Fbacteria-web.jpg&amp;f=1" width="350" />

</div>
<blockquote>
<p>The deadly <em>Caninus-morbidium</em> (CM) is believed to be headed your way. We’ve found that it likes warm water and low oxygen, but it really dislikes fish and fast moving water.</p>
<p>According to our measurements we’ve seen them living in temperatures greater than 23 C, but less than 28 C. The dissolved oxygen range has been greater than 4, but less than 6.</p>
</blockquote>
<p><strong>Which water bodies would be hospitable to this bacteria?</strong></p>
<p><br></p>
<p>Use <code>filter()</code> to find the water bodies that might be home to deadly <em>CM</em>.</p>
<p><br></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bad_water &lt;-<span class="st"> </span><span class="kw">filter</span>(sw_wide)</code></pre></div>
<div id="fast-water" class="section level3">
<h3>Fast water</h3>
<p>The function <code>grepl()</code> can be used to find the water bodies with “River” in their name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bad_water<span class="op">$</span>location

bad_water &lt;-<span class="st"> </span><span class="kw">filter</span>(bad_water, <span class="op">!</span><span class="kw">grepl</span>(<span class="st">&quot;River&quot;</span>, location))


<span class="co"># Use tolower() to account for capitalization issues</span>
bad_water &lt;-<span class="st"> </span><span class="kw">filter</span>(bad_water, <span class="op">!</span><span class="kw">grepl</span>(<span class="st">&quot;river&quot;</span>, <span class="kw">tolower</span>(location)))</code></pre></div>
</div>
<div id="now-lets-plot-the-data-for-one-of-these-water-bodies-over-time." class="section level3">
<h3>Now let’s plot the data for one of these water bodies over time.</h3>
<p>Maybe we can find some clues that point to a water body becoming infected with <em>CM</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This one is the best ditch</span>
favorite_wb &lt;-<span class="st">  &quot;Judicial Ditch 2&quot;</span>

sw_fav &lt;-<span class="st"> </span><span class="kw">filter</span>(sw_wide, location <span class="op">==</span><span class="st"> </span>favorite_wb)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sw_fav, <span class="kw">aes</span>(<span class="dt">x =</span> sample_date, <span class="dt">y =</span> DO_mg_per_L)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_datetime</span>() 

<span class="co"># ERROR! Nooo!!! See below to resolve.</span></code></pre></div>
<blockquote>
<p>Uh oh, this doesn’t work because our dates are character objects and are not date/time objects. What should we do now?</p>
</blockquote>
<ol style="list-style-type: upper-alpha">
<li>Give up. <em>(Return to top of page.)</em><br />
</li>
<li>Just keep trying the same script over and over again until it works. <em>(Return to beginning of this sentence and read again.)</em><br />
</li>
<li>Scroll down to find a package that will change columns into datetime objects. <em>(Continue below.)</em></li>
</ol>
<p><br></p>
</div>
<div id="good-choice" class="section level3">
<h3>Good choice!</h3>
<p>Let’s install <em>lubridate</em> to fix our date problems.</p>
<div class="figure">
<img src="https://d21ii91i3y6o6h.cloudfront.net/gallery_images/from_proof/9300/medium/1447175273/rstudio-hex-lubridate-dot-psd.png" />

</div>
<p><code>install.packages(&quot;lubridate&quot;)</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)

<span class="co"># Convert sample_date to date object (something R knows is a date)</span>
sw_fav &lt;-<span class="st"> </span><span class="kw">mutate</span>(sw_fav, <span class="dt">sample_date =</span> <span class="kw">mdy_hms</span>(sample_date))

<span class="co"># Try the plots again</span>

<span class="co"># DO over time</span>
<span class="kw">ggplot</span>(sw_fav, <span class="kw">aes</span>(<span class="dt">x =</span> sample_date, <span class="dt">y =</span> DO_mg_per_L)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_datetime</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title    =</span> <span class="st">&quot;DO over time at JD2&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;Yes, Judicial Ditch 2 is important&quot;</span>,
       <span class="dt">x =</span> <span class="st">&quot;Date of sample&quot;</span>, 
       <span class="dt">y =</span> <span class="st">&quot;Dissolved oxygen (mg/L)&quot;</span>)</code></pre></div>
<p><img src="03-Day3_db_connect_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Temperature over time</span>
<span class="kw">ggplot</span>(sw_fav, <span class="kw">aes</span>(<span class="dt">x =</span> sample_date, <span class="dt">y =</span> temp_C)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_datetime</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title    =</span> <span class="st">&quot;Temp over time at JD2&quot;</span>, 
       <span class="dt">subtitle =</span> <span class="st">&quot;Judicial Ditch 2 is still important&quot;</span>, 
       <span class="dt">x =</span> <span class="st">&quot;Date of sample&quot;</span>, 
       <span class="dt">y =</span> <span class="st">&quot;Temp (in Celsius because Fahrenheit is stupid)&quot;</span>)</code></pre></div>
<p><img src="03-Day3_db_connect_files/figure-html/unnamed-chunk-22-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Temperature vs DO correlation</span>
<span class="kw">ggplot</span>(sw_fav, <span class="kw">aes</span>(<span class="dt">x =</span> temp_C, <span class="dt">y =</span> DO_mg_per_L)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title    =</span> <span class="st">&quot;Temp vs. DO at JD2&quot;</span>, 
       <span class="dt">subtitle =</span> <span class="st">&quot;What is the relationship between temp and DO?&quot;</span>, 
       <span class="dt">x        =</span> <span class="st">&quot;Temp (in Celsius because Fahrenheit is so you know)&quot;</span>, 
       <span class="dt">y        =</span> <span class="st">&quot;Dissolved oxygen (mg/L)&quot;</span>)</code></pre></div>
<p><img src="03-Day3_db_connect_files/figure-html/unnamed-chunk-22-3.png" width="672" /></p>
<p><br></p>
</div>
</div>
</div>
<div id="air-data" class="section level1">
<h1>Air data</h1>
<div id="cedr-rapids-air-emissions-inventory" class="section level2">
<h2>CEDR / Rapids | Air emissions inventory</h2>
<p><strong>CEDR</strong> is the one and only central air emissions data repository. It stores air emission data about all kinds of sources in Minnesota.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RODBC)

<span class="co"># Connect to Delta</span>
deltaw &lt;-<span class="st"> </span><span class="kw">odbcConnect</span>(<span class="st">&quot;deltaw&quot;</span>, 
                      <span class="dt">uid =</span> user, 
                      <span class="dt">pwd =</span> password,
                      <span class="dt">believeNRows =</span> <span class="ot">FALSE</span>)  

<span class="co"># Show all tables in RAPIDS schema</span>
rapids_tbls &lt;-<span class="st"> </span><span class="kw">sqlTables</span>(deltaw, <span class="dt">tableType =</span> <span class="st">&quot;TABLE&quot;</span>, <span class="dt">schema =</span> <span class="st">&quot;RAPIDS&quot;</span>)  


<span class="co"># Get inventory year code</span>
inv_codes  &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="st">&quot;SELECT * FROM RAPIDS.INV_INVENTORIES&quot;</span>, 
                       <span class="dt">max =</span> <span class="dv">100</span>, 
                       <span class="dt">stringsAsFactors =</span> F)

<span class="co"># Get code for 2014</span>
inv_id  &lt;-<span class="st"> </span><span class="kw">filter</span>(inv_codes, INVENTORY_YEAR <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>)<span class="op">$</span>RID

<span class="co"># Get emissions for inventory year</span>
emissions   &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="kw">paste0</span>(<span class="st">&quot;SELECT * FROM RAPIDS.INV_PROCESS_EMISSIONS WHERE INVENTORY_RID = &quot;</span>, inv_id),
                        <span class="dt">max =</span> <span class="dv">10000</span>, 
                        <span class="dt">stringsAsFactors =</span> F, 
                        <span class="dt">as.is =</span> T)

<span class="co"># Additional SQL query options for emissions </span>
##&quot; AND MATERIAL_CODE = &#39;CO2&#39;&quot;,
##&quot; AND PROCESS_RID = &#39;101276120&#39;&quot;),


<span class="co"># Get emission units</span>
e_units  &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="kw">paste0</span>(<span class="st">&quot;SELECT * FROM RAPIDS.INV_EMISSION_UNITS WHERE INVENTORY_RID = &quot;</span>, inv_id), 
                        <span class="dt">max =</span> <span class="dv">10000</span>, 
                        <span class="dt">stringsAsFactors =</span> F, 
                        <span class="dt">as.is =</span> T)


<span class="co"># Get emission processes</span>
e_process  &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="kw">paste0</span>(<span class="st">&quot;SELECT * FROM RAPIDS.INV_PROCESSeS WHERE INVENTORY_RID = &quot;</span>, inv_id), 
                        <span class="dt">max =</span> <span class="dv">10000</span>, 
                        <span class="dt">stringsAsFactors =</span> F, 
                        <span class="dt">as.is =</span> T)


<span class="co"># Get SCC reference code description</span>
scc   &lt;-<span class="st"> </span><span class="kw">sqlQuery</span>(deltaw, <span class="kw">paste0</span>(<span class="st">&quot;SELECT * FROM RAPIDS.REF_SCC_CODES&quot;</span>),
                  <span class="dt">stringsAsFactors =</span> F, 
                  <span class="dt">as.is =</span> T)


<span class="co"># Join SCC code EI sector to source params</span>
e_process &lt;-<span class="st"> </span><span class="kw">left_join</span>(e_process, <span class="kw">select</span>(scc, SCC_CODE, EI_SECTOR))

<span class="co"># Convert SCC code to type character with as.character()</span>
e_process &lt;-<span class="st"> </span><span class="kw">mutate</span>(e_process, <span class="dt">SCC_CODE =</span> <span class="kw">as.character</span>(SCC_CODE))

<span class="co"># Try to join again</span>
e_process &lt;-<span class="st"> </span><span class="kw">left_join</span>(e_process, <span class="kw">select</span>(scc, SCC_CODE, EI_SECTOR))


<span class="co"># Check if EI_SECTOR column added to end of table</span>
<span class="kw">glimpse</span>(e_process)</code></pre></div>
<pre><code>## Observations: 10,000
## Variables: 33
## $ RID                          &lt;chr&gt; &quot;101131651&quot;, &quot;101131653&quot;, &quot;101131...
## $ INVENTORY_RID                &lt;chr&gt; &quot;101123730&quot;, &quot;101123730&quot;, &quot;101123...
## $ SOURCE_RID                   &lt;chr&gt; &quot;101131475&quot;, &quot;101131475&quot;, &quot;101131...
## $ EMISSION_UNIT_RID            &lt;chr&gt; &quot;101131650&quot;, &quot;101131652&quot;, &quot;101131...
## $ PROCESS_ID                   &lt;chr&gt; &quot;EU046PD001&quot;, &quot;EU047PD001&quot;, &quot;EU04...
## $ SCC_CODE                     &lt;chr&gt; &quot;10200603&quot;, &quot;20200102&quot;, &quot;20200102...
## $ CONFIDENTIAL_FLAG            &lt;chr&gt; &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;, &quot;N&quot;...
## $ SHORT_DESC                   &lt;chr&gt; &quot;Natural gas&quot;, &quot;Diesel&quot;, &quot;Diesel&quot;...
## $ AIRCRAFT_ENGINE_TYPE_CODE    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ EMISSION_TYPE_CODE           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ CONTROL_APPROACH_RID         &lt;chr&gt; NA, NA, NA, NA, NA, &quot;101131517&quot;, ...
## $ BEGIN_OPERATION_DATE         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ END_OPERATION_DATE           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ EIS_PROGRAM_SYSTEM_CODE      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ ID_EFFECTIVE_DATE            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ ID_END_DATE                  &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ PROCESS_EIS_ID               &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ MACT_CODE                    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ MACT_COMPLIANCE_STATUS       &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ WINTER_ACTIVITY_PCT          &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25...
## $ SPRING_ACTIVITY_PCT          &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25...
## $ SUMMER_ACTIVITY_PCT          &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25...
## $ FALL_ACTIVITY_PCT            &lt;chr&gt; &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25&quot;, &quot;25...
## $ ACTUAL_HOURS_PER_YEAR        &lt;chr&gt; &quot;43&quot;, &quot;44&quot;, &quot;44&quot;, &quot;50&quot;, &quot;50&quot;, &quot;86...
## $ ACTUAL_WEEKS_PER_YEAR        &lt;chr&gt; &quot;52&quot;, NA, NA, NA, NA, NA, NA, NA,...
## $ ANNUAL_AVERAGE_HOURS_PER_DAY &lt;chr&gt; &quot;24&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;24&quot;, &quot;...
## $ ANNUAL_AVERAGE_DAYS_PER_WEEK &lt;chr&gt; &quot;7&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;7&quot;, &quot;1&quot;...
## $ UPDATE_TIME                  &lt;chr&gt; &quot;2015-04-01 16:44:14.000000&quot;, &quot;20...
## $ UPDATE_USER                  &lt;chr&gt; &quot;NETSVCU&quot;, &quot;NETSVCU&quot;, &quot;NETSVCU&quot;, ...
## $ CREATE_TIME                  &lt;chr&gt; &quot;2014-12-08 09:00:13.000000&quot;, &quot;20...
## $ CREATE_USER                  &lt;chr&gt; &quot;CEDR&quot;, &quot;CEDR&quot;, &quot;CEDR&quot;, &quot;CEDR&quot;, &quot;...
## $ COMMENT_TEXT                 &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ EI_SECTOR                    &lt;chr&gt; &quot;Fuel Comb - Industrial Boilers, ...</code></pre>
</div>
</div>
<div id="microsoft-access" class="section level1">
<h1>Microsoft Access</h1>
<ol style="list-style-type: decimal">
<li>Your Microsoft drivers are old and only work in old school “32-bit” mode.
<ul>
<li>To switch to <em>32-bit</em> hipster mode, go to <em>Tools</em> &gt; <em>Global Options…</em></li>
<li>At the top next to “R version:”, select <em>Change…</em></li>
<li>Choose the <em>32-bit</em> version of R and click <em>OK.</em></li>
<li><strong>Close R</strong> by clicking the big red X, or pressing <code>CTRL + Q</code>.</li>
<li>Reopen your project.</li>
</ul></li>
<li>Now we can tell R the path to the Access db and the table name or view that we want to import from Access.</li>
<li>We pull in the movie data if it is not already in our environment.</li>
<li>Then we <code>left_join()</code> to the movie dataset to see which movies were released in the year of our births.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RODBC)   <span class="co"># For Access</span>
<span class="kw">library</span>(readxl)  <span class="co"># For Excel</span>
<span class="kw">library</span>(dplyr)   <span class="co"># For left_join</span>
<span class="kw">library</span>(stringr) <span class="co"># For cleaning text data with garbage and spaces</span>

db_path &lt;-<span class="st"> &quot;X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/Student Folder/Sample data/Varietal Data.accdb&quot;</span>

table_name &lt;-<span class="st"> &quot;Academy_awards&quot;</span>

bigdb &lt;-<span class="st"> </span><span class="kw">odbcConnectAccess2007</span>(db_path)

academy_awards &lt;-<span class="st"> </span><span class="kw">sqlFetch</span>(bigdb, table_name, 
                           <span class="dt">rownames =</span> F, 
                           <span class="dt">stringsAsFactors =</span> F)

<span class="kw">odbcClose</span>(bigdb) 


<span class="co"># Filter to only the best picture award category</span>
academy_awards &lt;-<span class="st"> </span><span class="kw">filter</span>(academy_awards, Category <span class="op">==</span><span class="st"> &quot;Best Picture&quot;</span>)


<span class="co"># Pull in movie data if it is not in your environment.</span>
movies &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="st">&quot;X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/Student Folder/Sample data/IMDB movie data.xlsx&quot;</span>, <span class="dt">sheet =</span> <span class="st">&quot;use_this&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>)

<span class="co"># Check movie titles</span>
movies<span class="op">$</span>movie_title <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<div id="left_join-1" class="section level2">
<h2>left_join()</h2>
<p>Now we’re ready to <code>left_join()</code> our two tables together.</p>
<p><img src = "images/left_join_cheat.png" width="420" style="margin-left: 0px;" alt="left_join example"/></p>
<p><br></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Join the award nominations to the movies data table</span>
awards_movies &lt;-<span class="st"> </span><span class="kw">left_join</span>(movies, academy_awards, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;movie_title&quot;</span> =<span class="st"> &quot;Nominee&quot;</span>))

<span class="co"># Select only rows that successfully joined and added a value to the Won? column</span>
winning_movies &lt;-<span class="st"> </span><span class="kw">filter</span>(awards_movies, <span class="op">!</span><span class="kw">is.na</span>(<span class="st">`</span><span class="dt">Won?</span><span class="st">`</span>))</code></pre></div>
</div>
<div id="find-the-director-with-the-most-wins" class="section level2">
<h2>Find the director with the most wins</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="co"># group_by() director name to count the number of times their name appears</span>
top_directors &lt;-<span class="st"> </span><span class="kw">group_by</span>(winning_movies, director_name) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">summarize</span>(<span class="dt">award_count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                   </span><span class="kw">arrange</span>(<span class="kw">desc</span>(award_count))

<span class="co"># Column plot of top 12</span>
<span class="kw">ggplot</span>(top_directors[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, ], <span class="kw">aes</span>(director_name, award_count)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_col</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>()</code></pre></div>
</div>
<div id="when-youre-done" class="section level2">
<h2>When you’re done</h2>
<ul>
<li>Switch your R version back to 64-bit in <strong>Tools</strong> &gt; <strong>Global options</strong>.</li>
<li>Close RStudio and re-open your project.</li>
</ul>
<p><br></p>
<p><em>You’ve reached the end of this path. Return to the top of the page and continue searching.</em></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
